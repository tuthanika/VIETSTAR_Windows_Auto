name: VIETSTAR build

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Chọn mode (ví dụ 7-32, 7-64, auto)'
        required: true
        default: 'auto'

jobs:
  build:
    runs-on: windows-latest
    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      REPO_PATH: ${{ github.workspace }}

      SCRIPT_REPO: github.com/tuthanika/VIETSTAR-Windows
      SCRIPT_PATH: C:\RUN

      RCLONE_CONF_REPO: github.com/tuthanika/Rclone-Auto-Refresh-Token
      RCLONE_CONFIG_PATH: C:\RUN\rclone.conf

      RCLONE_PATH: OD_APP-C03-vietstar
      ALIST_PATH: https://cloud.vietstarhp.com/od-app/C03.vietstar@vietstarhp.onmicrosoft.com

      vietstar: z.VIETSTAR
      silent: z.Silent
      oem: 0.OEM
      dll: 1.DLL
      driver: z.DRIVER
      iso: z.ISO
      boot7: z.BOOT7
      bootwim: C:\1

      rclone_flag: --fast-list --delete-during --checksum --no-update-modtime --transfers 8 --checkers 8 --contimeout 60s --timeout 300s --retries 3 --low-level-retries 10 --onedrive-delta --server-side-across-configs --onedrive-no-versions --onedrive-hard-delete --onedrive-av-override --drive-copy-shortcut-content --drive-acknowledge-abuse --drive-stop-on-upload-limit --drive-stop-on-download-limit --checksum --track-renames --no-update-modtime

      FILE_CODE_RULES: |
        [
          {
            "Mode": "7-32",
            "Folder": "Windows 7",
            "Patterns": ["*windows*7*86*.iso"],
            "DriverFolder": "DriverCeo/DP",
            "DriverPatterns": ["*Win7*x86*.iso"],
            "BootFolder": "z.BOOT7",
            "BootPatterns": ["*windows*7*86*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          },
          {
            "Mode": "7-64",
            "Folder": "Windows 7",
            "Patterns": ["*windows*7*64*.iso"],
            "DriverFolder": "DriverCeo/DP",
            "DriverPatterns": ["*7*64*.iso"],
            "BootFolder": "z.BOOT7",
            "BootPatterns": ["*7*64*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          },
          {
            "Mode": "11-64",
            "Folder": "Windows 11",
            "Patterns": ["*windows*11*version*64*.iso", "*windows*11*64*.iso"],
            "DriverFolder": "z.DRIVER",
            "DriverPatterns": ["*Win10*x64*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          },
          {
            "Mode": "11-64-ltsc",
            "Folder": "Windows 11 LTSC",
            "Patterns": ["*windows*11*ltsc*64*.iso"],
            "DriverFolder": "z.DRIVER",
            "DriverPatterns": ["*Win10*x64*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          }
        ]

    steps:
      - name: Checkout Auto repo
        uses: actions/checkout@v4

      - name: Clone SCRIPT_REPO
        run: |
          if (-not (Test-Path "C:\RUN")) { New-Item -ItemType Directory -Path "C:\RUN" }
          git clone https://${{ env.GH_PAT }}@${{ env.SCRIPT_REPO }} "${{ env.SCRIPT_PATH }}"

      - name: Setup rclone & aria2
        run: |
          choco install aria2 -y
          curl -L https://downloads.rclone.org/rclone-current-windows-amd64.zip -o rclone.zip
          tar -xf rclone.zip
          copy rclone-*-windows-amd64\rclone.exe "${{ env.SCRIPT_PATH }}\rclone.exe"

      - name: Download rclone.conf
        run: |
          git clone https://${{ env.GH_PAT }}@${{ env.RCLONE_CONF_REPO }} confrepo
          copy confrepo\rclone.conf "${{ env.SCRIPT_PATH }}\rclone.conf"

      - name: Copy helper scripts
        run: |
          copy prepare-build.cmd "${{ env.SCRIPT_PATH }}"
          copy upload-build.cmd "${{ env.SCRIPT_PATH }}"

      - name: Run build
        run: |
          cd "${{ env.SCRIPT_PATH }}"
          if "${{ github.event.inputs.mode }}"=="auto" (
            powershell -NoProfile -Command ^
              "$rules = $env:FILE_CODE_RULES | ConvertFrom-Json; ^
               foreach($r in $rules){ ^
                 cmd /c prepare-build.cmd $r.Mode; ^
                 if (Test-Path (Join-Path $env:SCRIPT_PATH (\"_skip_\" + $r.Mode + \".flag\"))) { ^
                   Write-Host \"[SKIP] Mode $($r.Mode) skipped\"; ^
                 } else { ^
                   cmd /c zzz.Windows-imdisk.cmd $r.Mode; ^
                   cmd /c upload-build.cmd $r.Mode; ^
                 } ^
               }"
          ) else (
            call prepare-build.cmd "${{ github.event.inputs.mode }}"
            if exist "_skip_${{ github.event.inputs.mode }}.flag" (
              echo [SKIP] Mode ${{ github.event.inputs.mode }} skipped
            ) else (
              call zzz.Windows-imdisk.cmd "${{ github.event.inputs.mode }}"
              call upload-build.cmd "${{ github.event.inputs.mode }}"
            )
          )
