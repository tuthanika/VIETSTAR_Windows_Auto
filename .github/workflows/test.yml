name: VIETSTAR build

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Chọn mode (ví dụ 7-32, 7-64, auto)'
        required: true
        default: '7-32'

jobs:
  build:
    runs-on: windows-latest
    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      ALIST_TOKEN: ${{ secrets.ALIST_TOKEN }}
      REPO_PATH: ${{ github.workspace }}

      SCRIPT_REPO: github.com/tuthanika/VIETSTAR-Windows
      SCRIPT_PATH: D:\RUN
      INSTALL_PATH: D:\INSTALL
      RCLONE_CONF_REPO: github.com/tuthanika/Rclone-Auto-Refresh-Token
      RCLONE_CONFIG_PATH: 'D:\RUN\rclone.conf'

      RCLONE_PATH: "OD_APP-C03-vietstar:"
      ALIST_HOST: https://cloud.vietstarhp.com
      ALIST_PATH: od-app/C03.vietstar@vietstarhp.onmicrosoft.com

      vietstar: z.VIETSTAR
      silent: z.Silent
      oem: 0.OEM
      dll: 1.DLL
      driver: z.DRIVER
      iso: z.ISO
      boot7: z.BOOT7
      bootwim: C:\1

      rclone_flag: --fast-list --delete-during --checksum --no-update-modtime --transfers 8 --checkers 8 --contimeout 60s --timeout 300s --retries 3 --low-level-retries 10 --onedrive-delta --server-side-across-configs --onedrive-no-versions --onedrive-hard-delete --onedrive-av-override --drive-copy-shortcut-content --drive-acknowledge-abuse --drive-stop-on-upload-limit --drive-stop-on-download-limit --checksum --track-renames --no-update-modtime

      FILE_CODE_RULES: |
        [
          {
            "Mode": "7-32",
            "Folder": "Windows 7",
            "Patterns": ["*windows*7*86*.iso"],
            "DriverFolder": "DriverCeo/DP",
            "DriverPatterns": ["*Win7*x86*.iso"],
            "BootFolder": "z.BOOT7",
            "BootPatterns": ["*windows*7*86*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*Lite*.iso"]
          },
          {
            "Mode": "7-64",
            "Folder": "Windows 7",
            "Patterns": ["*windows*7*64*.iso"],
            "DriverFolder": "DriverCeo/DP",
            "DriverPatterns": ["*7*64*.iso"],
            "BootFolder": "z.BOOT7",
            "BootPatterns": ["*7*64*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          },
          {
            "Mode": "11-64",
            "Folder": "Windows 11",
            "Patterns": ["*windows*11*version*64*.iso", "*windows*11*64*.iso"],
            "DriverFolder": "z.DRIVER",
            "DriverPatterns": ["*Win10*x64*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          },
          {
            "Mode": "11-64-ltsc",
            "Folder": "Windows 11 LTSC",
            "Patterns": ["*windows*11*ltsc*64*.iso"],
            "DriverFolder": "z.DRIVER",
            "DriverPatterns": ["*Win10*x64*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          }
        ]

      MAX_FILE: 1
      
    steps:
      - name: Checkout Auto repo
        uses: actions/checkout@v4

      - name: Clone SCRIPT_REPO
        run: |
          if (-not (Test-Path "${{ env.SCRIPT_PATH }}")) { New-Item -ItemType Directory -Path "${{ env.SCRIPT_PATH }}" }
          git clone https://${{ env.GH_PAT }}@${{ env.SCRIPT_REPO }} "${{ env.SCRIPT_PATH }}"

      - name: Prepare working directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path $env:SCRIPT_PATH -Force | Out-Null

      - name: Install aria2
        run: |
          choco install aria2 -y
          
      - name: Install ImDisk
        shell: pwsh
        run: |
          choco install imdisk -y
          & imdisk -v

      - name: Install rclone
        shell: pwsh
        run: |
          $zip = "$env:SCRIPT_PATH\rclone.zip"
          Invoke-WebRequest -Uri "https://downloads.rclone.org/rclone-current-windows-amd64.zip" -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath "$env:SCRIPT_PATH\rclone" -Force
          $exe = Get-ChildItem "$env:SCRIPT_PATH\rclone" -Recurse -Filter "rclone.exe" | Select-Object -First 1
          Copy-Item $exe.FullName "$env:SCRIPT_PATH\rclone.exe" -Force
          & "$env:SCRIPT_PATH\rclone.exe" version

      - name: Fetch rclone.conf from GitHub
        shell: cmd
        run: |
          curl -H "Authorization: token %GH_PAT%" ^
               -L -o "%RCLONE_CONFIG_PATH%" ^
               https://raw.githubusercontent.com/tuthanika/Rclone-Auto-Refresh-Token/main/rclone.conf
      
      - name: Copy build scripts
        shell: pwsh
        run: |
          mkdir $env:SCRIPT_PATH\build
          Copy-Item -Path build\* -Destination $env:SCRIPT_PATH\build -Recurse -Force
          Write-Host "Copied build scripts to $env:SCRIPT_PATH\build" 
        
      - name: Show free disk space after cleanup
        shell: cmd
        run: |
          fsutil volume diskfree C:
          fsutil volume diskfree D:
               
#      - name: Fast cleanup runner
#        shell: cmd
#        run: |
#          rd /s /q "C:\Program Files\Java"
#          rd /s /q "C:\Program Files\Android"
#          rd /s /q "C:\hostedtoolcache\windows\Python"
#          rd /s /q "C:\Program Files\nodejs"
#          rd /s /q "C:\Users\runneradmin\AppData\Local\Programs\Microsoft VS Code"
#          rd /s /q "C:\Program Files (x86)\Microsoft Visual Studio"
#          rd /s /q "C:\Program Files\Microsoft Visual Studio"
#          rd /s /q "C:\Program Files\dotnet\sdk"
#          rd /s /q "C:\Windows\SoftwareDistribution\Download"
#          rd /s /q "C:\Users\runneradmin\AppData\Local\Temp"
#          rd /s /q "C:\Windows\Temp"

      - name: Run integrated pipeline
        shell: pwsh
        run: |
          Set-Location $env:SCRIPT_PATH
          . "$env:SCRIPT_PATH\build\Main.ps1" "${{ github.event.inputs.mode }}"

