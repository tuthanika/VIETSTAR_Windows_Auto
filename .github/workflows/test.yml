name: VIETSTAR build

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Chọn mode (ví dụ 7-32, 7-64, auto)'
        required: true
        default: '7-32'

jobs:
  build:
    runs-on: windows-latest
    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      REPO_PATH: ${{ github.workspace }}

      SCRIPT_REPO: github.com/tuthanika/VIETSTAR-Windows
      SCRIPT_PATH: C:\RUN
      INSTALL_PATH: C:\INSTALL
      RCLONE_CONF_REPO: github.com/tuthanika/Rclone-Auto-Refresh-Token
      RCLONE_CONFIG_PATH: C:\RUN\rclone.conf

      RCLONE_PATH: "OD_APP-C03-vietstar:"

      ALIST_PATH: https://cloud.vietstarhp.com/od-app/C03.vietstar@vietstarhp.onmicrosoft.com

      vietstar: z.VIETSTAR
      silent: z.Silent
      oem: 0.OEM
      dll: 1.DLL
      driver: z.DRIVER
      iso: z.ISO
      boot7: z.BOOT7
      bootwim: C:\1

      rclone_flag: --fast-list --delete-during --checksum --no-update-modtime --transfers 8 --checkers 8 --contimeout 60s --timeout 300s --retries 3 --low-level-retries 10 --onedrive-delta --server-side-across-configs --onedrive-no-versions --onedrive-hard-delete --onedrive-av-override --drive-copy-shortcut-content --drive-acknowledge-abuse --drive-stop-on-upload-limit --drive-stop-on-download-limit --checksum --track-renames --no-update-modtime

      FILE_CODE_RULES: |
        [
          {
            "Mode": "7-32",
            "Folder": "Windows 7",
            "Patterns": ["*windows*7*86*.iso"],
            "DriverFolder": "DriverCeo/DP",
            "DriverPatterns": ["*Win7*x86*.iso"],
            "BootFolder": "z.BOOT7",
            "BootPatterns": ["*windows*7*86*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          },
          {
            "Mode": "7-64",
            "Folder": "Windows 7",
            "Patterns": ["*windows*7*64*.iso"],
            "DriverFolder": "DriverCeo/DP",
            "DriverPatterns": ["*7*64*.iso"],
            "BootFolder": "z.BOOT7",
            "BootPatterns": ["*7*64*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          },
          {
            "Mode": "11-64",
            "Folder": "Windows 11",
            "Patterns": ["*windows*11*version*64*.iso", "*windows*11*64*.iso"],
            "DriverFolder": "z.DRIVER",
            "DriverPatterns": ["*Win10*x64*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          },
          {
            "Mode": "11-64-ltsc",
            "Folder": "Windows 11 LTSC",
            "Patterns": ["*windows*11*ltsc*64*.iso"],
            "DriverFolder": "z.DRIVER",
            "DriverPatterns": ["*Win10*x64*.iso"],
            "SilentFolder": "z.Silent",
            "SilentPatterns": ["*lite*.iso"]
          }
        ]

      MAX_FILE: 1

    steps:
      - name: Checkout Auto repo
        uses: actions/checkout@v4

      - name: Prepare working directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "$env:SCRIPT_PATH" -Force | Out-Null
          New-Item -ItemType Directory -Path "$env:INSTALL_PATH" -Force | Out-Null

      - name: Clone SCRIPT_REPO
        run: |
          if (-not (Test-Path "${{ env.SCRIPT_PATH }}")) { New-Item -ItemType Directory -Path "${{ env.SCRIPT_PATH }}" }
          git clone https://${{ env.GH_PAT }}@${{ env.SCRIPT_REPO }} "${{ env.SCRIPT_PATH }}"

      - name: Install aria2
        run: |
          choco install aria2 -y

      - name: Install rclone
        shell: pwsh
        run: |
          $zip = "$env:INSTALL_PATH\rclone.zip"
          Invoke-WebRequest -Uri "https://downloads.rclone.org/rclone-current-windows-amd64.zip" -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath "$env:INSTALL_PATH\rclone" -Force
          $rcloneExe = Get-ChildItem "$env:INSTALL_PATH\rclone" -Recurse -Filter "rclone.exe" | Select-Object -First 1
          Copy-Item $rcloneExe.FullName "$env:SCRIPT_PATH\rclone.exe" -Force
          & "$env:SCRIPT_PATH\rclone.exe" version

      - name: Fetch rclone.conf from GitHub
        shell: cmd
        run: |
          curl -H "Authorization: token %GH_PAT%" ^
               -L -o "%SCRIPT_PATH%\rclone.conf" ^
               https://raw.githubusercontent.com/tuthanika/Rclone-Auto-Refresh-Token/main/rclone.conf

      - name: Copy helper scripts
        run: |
          copy prepare-build.cmd "${{ env.SCRIPT_PATH }}"
          copy upload-build.cmd "${{ env.SCRIPT_PATH }}"

      - name: Resolve modes and write rule envs
        run: |
          Set-Location "${{ env.SCRIPT_PATH }}"
          $rules = $env:FILE_CODE_RULES | ConvertFrom-Json
          if ("${{ github.event.inputs.mode }}" -eq "auto") {
            $modes = $rules.Mode
          } else {
            $modes = @("${{ github.event.inputs.mode }}")
          }
          Set-Content -Path "$env:SCRIPT_PATH\modes.txt" -Value ($modes -join "`n")
          foreach ($m in $modes) {
            $r = $rules | Where-Object { $_.Mode -eq $m }
            $kv = @()
            $kv += "mode=$($r.Mode)"
            $kv += "folder=$($r.Folder)"
            $kv += "patterns=$([string]::Join(';',$r.Patterns))"
            if ($r.DriverFolder)   { $kv += "drvFolder=$($r.DriverFolder)" }
            if ($r.DriverPatterns) { $kv += "drvPatterns=$([string]::Join(';',$r.DriverPatterns))" }
            if ($r.BootFolder)     { $kv += "bootFolder=$($r.BootFolder)" }
            if ($r.BootPatterns)   { $kv += "bootPatterns=$([string]::Join(';',$r.BootPatterns))" }
            if ($r.SilentFolder)   { $kv += "silentFolder=$($r.SilentFolder)" }
            if ($r.SilentPatterns) { $kv += "silentPatterns=$([string]::Join(';',$r.SilentPatterns))" }
            Set-Content -Path "$env:SCRIPT_PATH\rule.$m.env" -Value ($kv -join "`n")
          }

      - name: Prepare, build, upload per mode (with debug logs)
        shell: cmd
        run: |
          cd /d "${{ env.SCRIPT_PATH }}"
          for /f %%M in (modes.txt) do (
            echo [RUN] Mode %%M
            copy /y "rule.%%M.env" "rule.env" >nul
            call prepare-build.cmd %%M > prepare-%%M.log 2>&1
            echo -------- prepare-%%M.log --------
            type prepare-%%M.log
            if exist "_skip_%%M.flag" (
              echo [SKIP] Mode %%M skipped
            ) else (
              call zzz.Windows-imdisk.cmd %%M > build-%%M.log 2>&1
              echo -------- build-%%M.log --------
              type build-%%M.log
              call upload-build.cmd %%M > upload-%%M.log 2>&1
              echo -------- upload-%%M.log --------
              type upload-%%M.log
            )
          )
